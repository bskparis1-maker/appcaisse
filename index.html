<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>BSK - Caisse & Gestion</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app-container">
    <!-- ============ HEADER ============ -->
    <header class="header">
      <img src="logo.png" alt="Logo BSK" class="logo" />
      <div>
        <h1>BSK - Caisse</h1>
        <p class="subtitle">Caisse, stock, clients & bar à parfum</p>
      </div>
    </header>

    <!-- ============ NAVIGATION ============ -->
    <nav>
      <button onclick="showView('caisse')">Caisse</button>
      <button onclick="showView('ventes')">Ventes</button>
      <button onclick="showView('clients')">Clients</button>
      <button onclick="showView('produits')">Produits</button>
      <button onclick="showView('dashboard')">Tableau de bord</button>
      <button onclick="showView('frais')">Frais</button>
      <button onclick="showView('bar-parfum')">Bar à parfum</button>
    </nav>

    <!-- ============ VUE CAISSE ============ -->
    <section id="view-caisse" class="view">
      <h2>Caisse</h2>

      <div class="payment-section">
        <h3>Mode promo & Vente en gros</h3>
        <button class="secondary-btn" onclick="openPromoModal()">
          Activer / régler la promo
        </button>
        <label style="display:block; margin-top:8px;">
          <input type="checkbox" id="wholesale-mode" />
          Vente en gros (prix personnalisés, remises désactivées)
        </label>
      </div>

      <h3>Produits</h3>
      <div id="products-list"></div>

      <h3>Panier</h3>
      <div id="cart-list">Panier vide.</div>
      <p class="total-label">
        Total : <strong><span id="cart-total">0</span> FCFA</strong>
      </p>

      <div class="payment-section">
        <h3>Paiement & remise</h3>

        <label>
          Mode de paiement :
          <select id="payment-method">
            <option value="cash">Espèces</option>
            <option value="orange">Orange Money</option>
            <option value="wave">Wave</option>
          </select>
        </label>

        <div class="discount-box">
          <label>
            Remise (FCFA) :
            <input type="number" id="cart-discount" value="0" min="0" />
          </label>
          <label>
            Raison de la remise :
            <input
              type="text"
              id="cart-discount-reason"
              placeholder="Ex : geste commercial, famille…"
            />
          </label>
        </div>
      </div>

      <h3>Client</h3>
      <div>
        <label for="client-select">Compte client :</label>
        <select id="client-select"></select>
        <button class="secondary-btn" onclick="openAddClientModal()">
          Nouveau client
        </button>
      </div>

      <div style="margin-top:12px;">
        <button class="primary-btn" onclick="confirmSale()">
          Valider la vente
        </button>
        <button class="secondary-btn" onclick="printTicket()">
          Imprimer le ticket
        </button>
        <button class="danger-btn" onclick="clearCart()">
          Annuler le panier
        </button>
      </div>
    </section>

    <!-- ============ POPUP PROMO ============ -->
    <div
      id="promo-popup"
      class="view hidden"
      style="
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
      "
    >
      <div
        style="
          background: #ffffff;
          padding: 16px 18px;
          border-radius: 12px;
          max-width: 360px;
          width: 100%;
          box-shadow: 0 15px 35px rgba(15, 23, 42, 0.3);
        "
      >
        <h3>Configurer la promo</h3>

        <div class="discount-box">
          <label>
            Nouveau prix pour les produits à 8 000 FCFA :
            <input type="number" id="promo-8000" min="0" />
          </label>
          <label>
            Nouveau prix pour les produits à 5 000 FCFA :
            <input type="number" id="promo-5000" min="0" />
          </label>
          <label>
            Date de début :
            <input type="date" id="promo-start" />
          </label>
          <label>
            Date de fin :
            <input type="date" id="promo-end" />
          </label>
        </div>

        <div style="margin-top:10px;">
          <button class="primary-btn" onclick="savePromo()">Enregistrer</button>
          <button class="secondary-btn" onclick="closePromoPopup()">
            Fermer
          </button>
        </div>
      </div>
    </div>

    <!-- ============ VUE VENTES ============ -->
    <section id="view-ventes" class="view hidden">
      <h2>Ventes</h2>

      <div class="payment-section">
        <h3>Ventes du jour</h3>
        <label>
          Date :
          <input
            type="date"
            id="sales-date"
            onchange="updateSalesViewForSelectedDate()"
          />
        </label>

        <button class="secondary-btn" onclick="updateSalesViewForSelectedDate()">
          Actualiser
        </button>
        <button class="secondary-btn" onclick="refreshSalesFromSheet()">
          Recharger depuis Google Sheets
        </button>

        <button class="primary-btn" onclick="openDailyReportForSelectedDate()">
          Rapport du jour (PDF)
        </button>

        <div id="sales-debug" style="font-size:12px; color:#6b7280; margin-top:4px;"></div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Heure</th>
            <th>Produits</th>
            <th>Montant</th>
            <th>Paiement</th>
            <th>Client / Actions</th>
          </tr>
        </thead>
        <tbody id="sales-table-body"></tbody>
      </table>
    </section>

    <!-- ============ VUE CLIENTS ============ -->
    <section id="view-clients" class="view hidden">
      <h2>Clients</h2>

      <input
        type="text"
        id="client-search"
        placeholder="Rechercher un client (nom ou téléphone)…"
        oninput="renderClientsTable()"
      />

      <div style="margin-top:6px; margin-bottom:8px;">
        <button class="primary-btn" onclick="openAddClientModal()">
          Ajouter un client
        </button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Nom</th>
            <th>Téléphone</th>
            <th>Date de naissance</th>
            <th>Total dépensé</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="clients-table-body"></tbody>
      </table>

      <div class="card" style="margin-top:20px; padding:12px; border:1px solid #e5e7eb; border-radius:8px;">
        <h3 style="margin-top:0;">Anniversaires dans les 72h</h3>
        <div id="birthday-list" class="birthday-list"></div>
      </div>
    </section>

    <!-- ============ VUE PRODUITS ============ -->
    <section id="view-produits" class="view hidden">
      <h2>Produits & Stock</h2>
      <table>
        <thead>
          <tr>
            <th>Nom</th>
            <th>Prix (FCFA)</th>
            <th>Stock actuel</th>
            <th>Nouveau stock</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="products-table-body"></tbody>
      </table>

      <h3 style="margin-top:24px;">Historique des mouvements de stock</h3>

      <div class="dashboard-filters">
        <div>
          <label>Du : <input type="date" id="stock-history-start" onchange="renderStockHistoryTable()" /></label>
          <label>au : <input type="date" id="stock-history-end" onchange="renderStockHistoryTable()" /></label>
        </div>
        <div class="dashboard-quick">
          <button class="secondary-btn" onclick="setStockHistoryRangeToday()">Aujourd'hui</button>
          <button class="secondary-btn" onclick="setStockHistoryRangeWeek()">Cette semaine</button>
          <button class="secondary-btn" onclick="setStockHistoryRangeMonth()">Ce mois</button>
          <button class="secondary-btn" onclick="setStockHistoryRangeYear()">Cette année</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Date / Heure</th>
            <th>Produit</th>
            <th>Ancien stock</th>
            <th>Nouveau stock</th>
            <th>Variation</th>
            <th>Motif</th>
          </tr>
        </thead>
        <tbody id="stock-history-body"></tbody>
      </table>
    </section>

    <!-- ============ VUE TABLEAU DE BORD ============ -->
    <section id="view-dashboard" class="view hidden">
      <h2>Tableau de bord</h2>

      <div class="dashboard-filters">
        <div>
          <label>Du : <input type="date" id="dashboard-start" onchange="loadDashboardStats()" /></label>
          <label>au : <input type="date" id="dashboard-end" onchange="loadDashboardStats()" /></label>
        </div>
        <div class="dashboard-quick">
          <button class="secondary-btn" onclick="setDashboardRangeToday()">Aujourd'hui</button>
          <button class="secondary-btn" onclick="setDashboardRangeWeek()">Cette semaine</button>
          <button class="secondary-btn" onclick="setDashboardRangeMonth()">Ce mois</button>
          <button class="secondary-btn" onclick="setDashboardRangeYear()">Cette année</button>
        </div>
      </div>

      <div class="dashboard-summary">
        <div class="card"><div class="label">Chiffre d'affaires</div><div class="value"><span id="db-total">0</span> FCFA</div></div>
        <div class="card"><div class="label">Nombre de ventes</div><div class="value" id="db-count">0</div></div>
        <div class="card"><div class="label">Panier moyen</div><div class="value"><span id="db-average">0</span> FCFA</div></div>
        <div class="card"><div class="label">Remises totales</div><div class="value"><span id="db-discount">0</span> FCFA</div></div>
        <div class="card"><div class="label">Espèces</div><div class="value"><span id="db-cash">0</span> FCFA</div></div>
        <div class="card"><div class="label">Orange Money</div><div class="value"><span id="db-orange">0</span> FCFA</div></div>
        <div class="card"><div class="label">Wave</div><div class="value"><span id="db-wave">0</span> FCFA</div></div>
      </div>

      <div style="margin-top:18px;">
        <canvas id="dashboard-chart" width="400" height="200"></canvas>
      </div>
    </section>

    <!-- ============ VUE FRAIS ============ -->
    <section id="view-frais" class="view hidden">
      <h2>Frais</h2>

      <h3>Nouvelle dépense</h3>
      <div class="payment-section">
        <div class="discount-box">
          <label>Motif de la dépense : <input type="text" id="expense-label" placeholder="Ex : Loyer boutique, Fournisseur, Transport..." /></label>
          <label>Montant (FCFA) : <input type="number" id="expense-amount" min="0" placeholder="0" /></label>
        </div>
        <button class="primary-btn" onclick="addExpense()">Valider la dépense</button>
      </div>

      <h3>Historique des frais</h3>

      <div class="dashboard-filters">
        <div>
          <label>Du : <input type="date" id="expense-history-start" onchange="renderExpensesTable()" /></label>
          <label>au : <input type="date" id="expense-history-end" onchange="renderExpensesTable()" /></label>
        </div>
        <div class="dashboard-quick">
          <button class="secondary-btn" onclick="setExpenseHistoryRangeToday()">Aujourd'hui</button>
          <button class="secondary-btn" onclick="setExpenseHistoryRangeWeek()">Cette semaine</button>
          <button class="secondary-btn" onclick="setExpenseHistoryRangeMonth()">Ce mois</button>
          <button class="secondary-btn" onclick="setExpenseHistoryRangeYear()">Cette année</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Date / Heure</th>
            <th>Motif</th>
            <th>Montant (FCFA)</th>
          </tr>
        </thead>
        <tbody id="expense-history-body"></tbody>
      </table>
    </section>

    <!-- ============ VUE BAR À PARFUM ============ -->
    <section id="view-bar-parfum" class="view hidden">
      <h2>Bar à parfum</h2>
      <table>
        <thead>
          <tr>
            <th>Référence</th>
            <th>Niveau</th>
          </tr>
        </thead>
        <tbody id="perfume-table-body"></tbody>
      </table>
    </section>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="app.js"></script>

  <!-- MODALE AJOUT / MODIF CLIENT -->
  <div id="client-form-modal" class="modal hidden">
    <div class="modal-content">
      <h3 id="client-form-title">Ajouter un client</h3>

      <label>Nom</label>
      <input type="text" id="client-form-name" placeholder="Nom du client">

      <label>Téléphone (optionnel)</label>
      <input type="text" id="client-form-phone" placeholder="Téléphone">

      <label>Date de naissance (optionnel)</label>
      <input type="date" id="client-form-birthdate">

      <div style="margin-top:10px; display:flex; gap:8px;">
        <button class="primary-btn" onclick="saveClientFromModal()">Enregistrer</button>
        <button class="secondary-btn" onclick="closeClientFormModal()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- ✅ POPUP INFOS CLIENT (MANQUANTE AVANT => CLIC NE FONCTIONNAIT PAS) -->
  <div id="popup-client" class="modal hidden">
    <div class="modal-content" style="max-width:650px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h3 style="margin:0;">Informations client</h3>
        <button class="secondary-btn" onclick="closeClientPopup()">Fermer</button>
      </div>

      <div style="margin-top:10px;">
        <div><strong>Nom :</strong> <span id="popup-client-name"></span></div>
        <div><strong>Téléphone :</strong> <span id="popup-client-phone"></span></div>
      </div>

      <h4 style="margin-top:14px;">Historique des achats</h4>
      <div id="popup-client-history" style="max-height:320px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; padding:10px;"></div>
    </div>
  </div>
</body>
</html>
